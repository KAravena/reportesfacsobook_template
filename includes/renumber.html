<script>
document.addEventListener('DOMContentLoaded', () => {
  const isNumeric = (value) => /^\d+$/.test(value);

  const removeSpacer = (node) => {
    let sibling = node.nextSibling;
    while (sibling && sibling.nodeType === Node.TEXT_NODE) {
      const cleaned = sibling.textContent.replace(/\u00a0/g, '').trim();
      const next = sibling.nextSibling;
      if (cleaned.length === 0) {
        sibling.remove();
        sibling = next;
      } else {
        break;
      }
    }
  };

  const hideChapterNumber = (el) => {
    if (!el) return;
    el.textContent = '';
    el.classList.add('chapter-number--hidden');
    el.style.display = 'none';
    removeSpacer(el);
  };

  const shiftChapterNumber = (el) => {
    if (!el) return;
    const value = (el.textContent || '').trim();
    if (!isNumeric(value)) {
      return;
    }
    const num = parseInt(value, 10);
    if (Number.isNaN(num) || num <= 1) {
      hideChapterNumber(el);
      return;
    }
    el.textContent = String(num - 1);
  };

  const sidebarChapters = document.querySelectorAll('.sidebar .chapter-number');
  sidebarChapters.forEach((el, idx) => {
    if (idx === 0) {
      hideChapterNumber(el);
    } else {
      shiftChapterNumber(el);
    }
  });

  document.querySelectorAll('.chapter-number').forEach((el) => {
    if (el.closest('.sidebar')) {
      return;
    }
    shiftChapterNumber(el);
  });

  document.querySelectorAll('[data-number]').forEach((el) => {
    const link = el.closest('a');
    const href =
      (link && link.getAttribute('href')) ||
      el.getAttribute('href') ||
      '';
    if (/\/?index\.html(?:#|$)/i.test(href)) {
      el.setAttribute('data-number', '');
      return;
    }

    const current = el.getAttribute('data-number');
    if (!current || !isNumeric(current)) {
      return;
    }

    const num = parseInt(current, 10);
    if (Number.isNaN(num) || num <= 1) {
      el.setAttribute('data-number', '');
      return;
    }

    el.setAttribute('data-number', String(num - 1));
  });

  const expandMarginToc = () => {
    const toc = document.getElementById('TOC');
    if (!toc) return;

    toc.querySelectorAll('ul.collapse').forEach((node) => {
      node.classList.remove('collapse');
      node.classList.add('toc-expanded');
    });

    toc.querySelectorAll('[data-bs-toggle="collapse"]').forEach((trigger) => {
      trigger.removeAttribute('data-bs-toggle');
      trigger.setAttribute('aria-expanded', 'true');
    });
  };

  expandMarginToc();
});
</script>
<style>
.chapter-number--hidden {
  display: none !important;
}
.toc-expanded {
  display: block !important;
  visibility: visible !important;
  height: auto !important;
  overflow: visible !important;
}
</style>
